<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Straive Consistency Dashboard</title>
    <style>
        :root { 
            --straive-blue: #002d72; 
            --straive-light: #f4f7f6;
            --highlight-bg: #d1e7dd; 
            --highlight-border: #198754; 
        }
        
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background: var(--straive-light); color: #333; }
        
        .grid { display: grid; grid-template-columns: 480px 1fr; gap: 25px; align-items: start; }
        
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); padding: 25px; }
        
        h2 { color: var(--straive-blue); margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        #jsonBox { 
            background: #1e1e1e; 
            color: #9cdcfe; 
            padding: 15px; 
            border-radius: 6px; 
            font-family: 'Consolas', 'Monaco', monospace; 
            font-size: 12px; 
            white-space: pre-wrap; 
            height: 450px; 
            overflow-y: auto;
            border: 1px solid #333;
        }
        
        textarea { 
            width: 100%; 
            height: 200px; 
            padding: 12px; 
            border: 1px solid #ccc; 
            border-radius: 6px; 
            box-sizing: border-box; 
            font-size: 14px;
            line-height: 1.5;
            resize: vertical;
        }
        
        #output { 
            border: 1px solid #ccc; 
            padding: 20px; 
            border-radius: 6px; 
            background: #fff; 
            min-height: 200px; 
            line-height: 1.6; 
            white-space: pre-wrap;
            font-size: 14px;
        }
        
        .btn { 
            padding: 12px 20px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: 600; 
            width: 100%; 
            margin: 15px 0; 
            transition: opacity 0.2s;
            color: white;
        }
        
        .btn-primary { background: var(--straive-blue); }
        .btn-success { background: #198754; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .btn:hover:not(:disabled) { opacity: 0.9; }

        .btn.loading {
            position: relative;
            overflow: hidden;
        }

        .btn.loading::after {
            content: "";
            position: absolute;
            top: 0;
            left: -60%;
            width: 60%;
            height: 100%;
            background: linear-gradient(110deg, transparent, rgba(255,255,255,0.55), transparent);
            animation: btn-sweep 1.1s linear infinite;
        }

        /* Highlighting Logic */
        .hl { 
            background-color: var(--highlight-bg); 
            border-bottom: 2px solid var(--highlight-border); 
            font-weight: bold; 
            padding: 0 2px;
            border-radius: 2px;
        }
        
        .pill { 
            display: inline-block; 
            background: #f8f9fa; 
            padding: 5px 12px; 
            border-radius: 20px; 
            font-size: 12px; 
            margin: 4px; 
            border: 1px solid #dee2e6;
            color: #495057;
            font-weight: 500;
        }

        .section-label { font-weight: bold; display: block; margin-bottom: 8px; color: var(--straive-blue); }

        .compare-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 8px 0 12px;
        }

        .compare-option {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 18px;
            padding: 6px 10px;
            font-size: 12px;
            color: #495057;
            cursor: pointer;
        }

        .compare-option input { margin-right: 6px; }
        .compare-option.disabled { opacity: 0.6; cursor: not-allowed; }
        .compare-option.disabled input { cursor: not-allowed; }

        .provider-note { color: #b02a37; font-weight: 600; margin-left: 4px; }

        #compareResults { 
            margin-top: 12px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 10px;
        }

        .compare-input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 12px;
            margin-bottom: 10px;
        }

        .compare-item {
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 12px;
            background: #fafafa;
            margin-bottom: 10px;
        }

        .compare-header {
            font-weight: 600;
            color: var(--straive-blue);
            margin-bottom: 6px;
        }

        .compare-title {
            font-size: 11px;
            font-weight: 600;
            color: #333;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            margin-bottom: 6px;
        }

        .compare-meta {
            font-size: 12px;
            color: #555;
            margin-bottom: 8px;
        }

        .compare-output {
            background: #fff;
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            padding: 8px;
            white-space: pre-wrap;
            line-height: 1.5;
            margin-bottom: 8px;
        }

        .compare-json {
            background: #111;
            color: #cde9ff;
            padding: 10px;
            border-radius: 6px;
            white-space: pre-wrap;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
        }

        .compare-error { color: #b02a37; font-weight: 600; }

        .toggle-btn {
            background: #e9ecef;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            color: #333;
            cursor: pointer;
            font-size: 12px;
            padding: 6px 10px;
            margin: 6px 0;
        }

        .toggle-btn:hover { background: #dee2e6; }

        .toggle-content { display: none; margin-top: 6px; }

        #jsonBox.loading {
            position: relative;
            overflow: hidden;
        }

        #jsonBox.loading::after {
            content: "";
            position: absolute;
            top: 0;
            left: -50%;
            width: 50%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.08), transparent);
            animation: json-shimmer 1.4s linear infinite;
        }

        #jsonBox.loaded {
            animation: json-pop 280ms ease-out;
        }

        #output.loading {
            position: relative;
            overflow: hidden;
            opacity: 0.85;
        }

        #output.loading::after {
            content: "";
            position: absolute;
            top: 0;
            left: -50%;
            width: 50%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0,0,0,0.06), transparent);
            animation: json-shimmer 1.1s linear infinite;
        }

        @keyframes btn-sweep {
            0% { left: -60%; }
            100% { left: 120%; }
        }

        @keyframes json-shimmer {
            0% { left: -50%; }
            100% { left: 120%; }
        }

        @keyframes json-pop {
            0% { transform: scale(0.98); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>

<h2>Universal Consistency Engine</h2>

<div class="grid">
    <div class="card">
        <span class="section-label">1. Knowledge Extraction</span>
        <p style="font-size: 13px; color: #666;">Upload your Style Guide (PDF/DOCX/TXT) to generate JSON logic.</p>
        <input type="file" id="fileIn" accept=".txt,.docx" style="width: 100%;">
        <button class="btn btn-primary" id="extractBtn" onclick="buildRules()">EXTRACT JSON RULES</button>
        <button class="btn btn-success" id="downloadBtn" onclick="downloadJson()" disabled>DOWNLOAD JSON</button>
        <div id="jsonBox">// Extracted rules will appear here...</div>
    </div>

    <div class="card">
        <span class="section-label">2. Deterministic Correction</span>
        <textarea id="rawInput" placeholder="Paste your technical text here for correction..."></textarea>
        
        <button class="btn btn-success" id="runBtn" onclick="runProcess()" disabled>APPLY & HIGHLIGHT</button>
        
        <span class="section-label">Corrected Output:</span>
        <div id="output">Review the corrected text here...</div>
        
        <div id="log" style="margin-top: 20px; padding-top: 15px; border-top: 1px dashed #ccc;">
            <strong>Audit Trail:</strong><br>
            <div id="pillsContainer" style="margin-top: 10px;"></div>
        </div>

        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px dashed #ccc;">
            <span class="section-label">Compare Models</span>
            <div class="compare-options">
                <label class="compare-option">
                    <input type="checkbox" class="compare-checkbox" data-provider="llmfoundry" data-model="gemini-2.0-flash" checked>
                    Foundry: gemini-2.0-flash
                </label>
                <label class="compare-option">
                    <input type="checkbox" class="compare-checkbox" data-provider="openai" data-model="gpt-4o-mini">
                    OpenAI (Foundry): gpt-4o-mini
                </label>
                <label class="compare-option">
                    <input type="checkbox" class="compare-checkbox" data-provider="vertexai-anthropic" data-model="claude-3-haiku@20240307">
                    Vertex AI (Anthropic): claude-3-haiku@20240307
                </label>
                <label class="compare-option">
                    <input type="checkbox" class="compare-checkbox" data-provider="groq" data-model="llama-3.3-70b-versatile">
                    Groq (Foundry): llama-3.3-70b-versatile
                </label>
            </div>
            <input id="foundryModels" class="compare-input" type="text" placeholder="Add Foundry models (comma-separated), e.g. gemini-2.0-flash, gemini-1.5-flash">
            <button class="btn btn-primary" onclick="runCompare()">COMPARE MODELS</button>
            <div id="providerStatus" style="font-size: 12px; color: #666; margin-top: 6px;"></div>
            <div id="compareResults"></div>
        </div>
    </div>
</div>

<script>
    let latestConfig = null;
    let providerStatus = { llmfoundry: true, openai: false, groq: false, "vertexai-anthropic": false };

    // 1. Build JSON Rules from File
    async function buildRules() {
        const fileInput = document.getElementById('fileIn');
        if (!fileInput.files[0]) return alert("Please select a file first.");

        const extractBtn = document.getElementById('extractBtn');
        const jsonBox = document.getElementById('jsonBox');
        const originalText = extractBtn.textContent;

        extractBtn.disabled = true;
        extractBtn.classList.add('loading');
        extractBtn.textContent = "EXTRACTING...";
        jsonBox.classList.remove('loaded');
        jsonBox.classList.add('loading');
        
        const fd = new FormData(); 
        fd.append('file', fileInput.files[0]);
        
        try {
            const res = await fetch('/upload_and_build', { method: 'POST', body: fd });
            const data = await res.json();
            
            if (data.error) throw new Error(data.error);
            
            latestConfig = data.config || [];
            document.getElementById('jsonBox').innerText = JSON.stringify(latestConfig, null, 2);
            document.getElementById('runBtn').disabled = false;
            document.getElementById('downloadBtn').disabled = false;
        } catch (err) {
            alert("Error building rules: " + err.message);
        } finally {
            extractBtn.disabled = false;
            extractBtn.classList.remove('loading');
            extractBtn.textContent = originalText;
            jsonBox.classList.remove('loading');
            jsonBox.classList.add('loaded');
        }
    }

    // 2. Process Text and Apply Highlights
    async function runProcess() {
        const text = document.getElementById('rawInput').value;
        const outputDiv = document.getElementById('output');
        const pillsContainer = document.getElementById('pillsContainer');
        const runBtn = document.getElementById('runBtn');
        const originalText = runBtn.textContent;
        
        if (!text) return alert("Please enter text to process.");

        try {
            runBtn.disabled = true;
            runBtn.classList.add('loading');
            runBtn.textContent = "APPLYING...";
            outputDiv.classList.remove('loaded');
            outputDiv.classList.add('loading');

            const res = await fetch('/process_text', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ text })
            });
            
            const data = await res.json();
            if (data.error) throw new Error(data.error);

            let processedHtml = data.corrected_text;
            pillsContainer.innerHTML = "";

            if (data.changes && data.changes.length > 0) {
                // Sort changes by length descending to prevent shorter strings 
                // from breaking tags of longer strings
                const sortedChanges = [...data.changes].sort((a, b) => b.new.length - a.new.length);

                sortedChanges.forEach(change => {
                    // Check if a real change happened
                    if (change.original.trim() !== change.new.trim()) {
                        
                        // REGEX: Escape special chars (like ' in 1990's) so they don't break the finder
                        const escapedNew = change.new.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
                        const findRegex = new RegExp(`(${escapedNew})`, 'g');
                        
                        // Wrap the NEW text in the highlight class
                        processedHtml = processedHtml.replace(findRegex, `<span class="hl">$1</span>`);
                        
                        // Add to Audit Pill
                        const pill = document.createElement('span');
                        pill.className = 'pill';
                        pill.innerHTML = `<b>${change.rule_id}</b>: ${change.original} &rarr; ${change.new}`;
                        pillsContainer.appendChild(pill);
                    }
                });
            } else {
                pillsContainer.innerHTML = "<em>Compliant. No corrections made.</em>";
            }

            outputDiv.innerHTML = processedHtml;

        } catch (err) {
            alert("Error processing text: " + err.message);
        } finally {
            runBtn.disabled = false;
            runBtn.classList.remove('loading');
            runBtn.textContent = originalText;
            outputDiv.classList.remove('loading');
            outputDiv.classList.add('loaded');
        }
    }

    // 3. Compare models with the same input
    async function runCompare() {
        const text = document.getElementById('rawInput').value;
        if (!text) return alert("Please enter text to process.");

        const selected = Array.from(document.querySelectorAll('.compare-checkbox:checked'))
            .map(cb => ({
                provider: cb.getAttribute('data-provider'),
                model: cb.getAttribute('data-model')
            }));

        const foundryInput = document.getElementById('foundryModels').value || "";
        const foundryModels = foundryInput
            .split(',')
            .map(m => m.trim())
            .filter(m => m.length > 0);

        foundryModels.forEach(model => {
            selected.push({ provider: "llmfoundry", model });
        });

        const unique = new Map();
        selected.forEach(item => {
            const key = `${item.provider}:${item.model}`;
            if (!unique.has(key)) unique.set(key, item);
        });

        const targets = Array.from(unique.values());
        const availableTargets = targets.filter(t => providerStatus[t.provider]);

        if (availableTargets.length === 0) {
            return alert("Please select at least one model to compare.");
        }

        const resultsDiv = document.getElementById('compareResults');
        resultsDiv.innerHTML = "Comparing models...";

        try {
            const res = await fetch('/process_text_compare', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ text, targets: availableTargets })
            });

            const data = await res.json();
            if (data.error) throw new Error(data.error);

            const results = data.results || {};
            const errors = data.errors || {};
            resultsDiv.innerHTML = "";

            availableTargets.forEach(target => {
                const key = `${target.provider}:${target.model}`;
                const item = document.createElement('div');
                item.className = 'compare-item';

                const header = document.createElement('div');
                header.className = 'compare-header';
                header.textContent = key;
                item.appendChild(header);

                if (results[key]) {
                    const result = results[key];
                    const changes = Array.isArray(result.changes) ? result.changes : [];
                    const actualChanges = filterActualChanges(changes, text);

                    const meta = document.createElement('div');
                    meta.className = 'compare-meta';
                    meta.textContent = `Changes: ${actualChanges.length}`;
                    item.appendChild(meta);

                    const label = document.createElement('div');
                    label.className = 'compare-title';
                    label.textContent = "Corrected output";
                    item.appendChild(label);

                    let correctedText = "";
                    if (Object.prototype.hasOwnProperty.call(result, "corrected_text")) {
                        correctedText = result.corrected_text;
                    }
                    if (typeof correctedText !== "string") {
                        correctedText = JSON.stringify(correctedText ?? "", null, 2);
                    }
                    const safeText = correctedText.trim().length ? correctedText : "No corrected_text returned.";

                    const output = document.createElement('div');
                    output.className = 'compare-output';
                    output.innerHTML = highlightCorrectedText(text, safeText);
                    item.appendChild(output);

                    if (actualChanges.length > 0) {
                        const list = document.createElement('div');
                        list.className = 'toggle-content';
                        actualChanges.forEach(change => {
                            const line = document.createElement('div');
                            line.textContent = `${change.rule_id || "rule"}: ${change.original || ""} -> ${change.new || ""}`;
                            list.appendChild(line);
                        });
                        const changesBtn = createToggleButton("Show changes", list);
                        item.appendChild(changesBtn);
                        item.appendChild(list);
                    }

                    const rawPayload = Object.assign({}, result);
                    if (Object.prototype.hasOwnProperty.call(rawPayload, "corrected_text")) {
                        delete rawPayload.corrected_text;
                    }

                    const pre = document.createElement('pre');
                    pre.className = 'compare-json';
                    pre.textContent = JSON.stringify(rawPayload, null, 2);
                    const rawWrap = document.createElement('div');
                    rawWrap.className = 'toggle-content';
                    rawWrap.appendChild(pre);
                    const jsonBtn = createToggleButton("Show JSON", rawWrap);
                    item.appendChild(jsonBtn);
                    item.appendChild(rawWrap);
                } else if (errors[key]) {
                    const err = document.createElement('div');
                    err.className = 'compare-error';
                    err.textContent = errors[key];
                    item.appendChild(err);
                } else {
                    const empty = document.createElement('div');
                    empty.textContent = "No output returned.";
                    item.appendChild(empty);
                }

                resultsDiv.appendChild(item);
            });
        } catch (err) {
            resultsDiv.innerHTML = "";
            alert("Error comparing models: " + err.message);
        }
    }

    function createToggleButton(label, contentEl) {
        const button = document.createElement('button');
        button.type = "button";
        button.className = "toggle-btn";
        button.textContent = label;
        button.addEventListener('click', () => {
            const isHidden = contentEl.style.display === "" || contentEl.style.display === "none";
            contentEl.style.display = isHidden ? "block" : "none";
            button.textContent = isHidden ? label.replace("Show", "Hide") : label;
        });
        return button;
    }

    function escapeHtml(text) {
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#39;");
    }

    function highlightCorrectedText(sourceText, correctedText) {
        const source = typeof sourceText === "string" ? sourceText : "";
        const corrected = typeof correctedText === "string" ? correctedText : "";
        if (!source || !corrected || source === corrected) {
            return escapeHtml(corrected);
        }

        const sourceTokens = tokenizeForDiff(source);
        const correctedTokens = tokenizeForDiff(corrected);
        const lcsTable = buildLcsTable(sourceTokens, correctedTokens);
        const diffParts = buildDiffParts(sourceTokens, correctedTokens, lcsTable);

        let html = "";
        diffParts.forEach(part => {
            if (part.type === "equal") {
                html += escapeHtml(part.value);
            } else if (part.type === "insert") {
                html += `<span class="hl">${escapeHtml(part.value)}</span>`;
            }
        });

        return html;
    }

    function tokenizeForDiff(text) {
        return text.split(/(\s+)/);
    }

    function buildLcsTable(a, b) {
        const n = a.length;
        const m = b.length;
        const table = Array.from({ length: n + 1 }, () => Array(m + 1).fill(0));
        for (let i = n - 1; i >= 0; i--) {
            for (let j = m - 1; j >= 0; j--) {
                if (a[i] === b[j]) {
                    table[i][j] = table[i + 1][j + 1] + 1;
                } else {
                    table[i][j] = Math.max(table[i + 1][j], table[i][j + 1]);
                }
            }
        }
        return table;
    }

    function buildDiffParts(a, b, table) {
        const parts = [];
        let i = 0;
        let j = 0;
        while (i < a.length && j < b.length) {
            if (a[i] === b[j]) {
                parts.push({ type: "equal", value: b[j] });
                i += 1;
                j += 1;
            } else if (table[i + 1][j] >= table[i][j + 1]) {
                parts.push({ type: "delete", value: a[i] });
                i += 1;
            } else {
                parts.push({ type: "insert", value: b[j] });
                j += 1;
            }
        }
        while (j < b.length) {
            parts.push({ type: "insert", value: b[j] });
            j += 1;
        }
        return parts;
    }

    function filterActualChanges(changes, sourceText) {
        if (!Array.isArray(changes)) {
            return [];
        }
        const source = typeof sourceText === "string" ? sourceText : "";
        const normalizedSource = normalizeApostrophes(source);
        return changes.filter(change => {
            const original = typeof change.original === "string" ? change.original.trim() : "";
            const updated = typeof change.new === "string" ? change.new.trim() : "";
            if (!original || original === updated) {
                return false;
            }
            const normalizedOriginal = normalizeApostrophes(original);
            return source.includes(original) || normalizedSource.includes(normalizedOriginal);
        });
    }

    function normalizeApostrophes(text) {
        return text.replace(/[\u2018\u2019\u02BC]/g, "'");
    }

    async function loadProviderStatus() {
        const statusEl = document.getElementById('providerStatus');
        try {
            const res = await fetch('/providers');
            providerStatus = await res.json();
            statusEl.textContent = "";
        } catch (err) {
            providerStatus = { llmfoundry: true, openai: false, groq: false, "vertexai-anthropic": false };
            statusEl.textContent = "Provider status unavailable. Using Foundry only.";
        }

        const labels = Array.from(document.querySelectorAll('.compare-option'));
        let disabledCount = 0;
        labels.forEach(label => {
            const checkbox = label.querySelector('input.compare-checkbox');
            const provider = checkbox.getAttribute('data-provider');
            const enabled = !!providerStatus[provider];

            if (!enabled) {
                disabledCount += 1;
                checkbox.checked = false;
                checkbox.disabled = true;
                label.classList.add('disabled');
                if (!label.querySelector('.provider-note')) {
                    const note = document.createElement('span');
                    note.className = 'provider-note';
                    note.textContent = "(not configured)";
                    label.appendChild(note);
                }
            }
        });

        if (statusEl.textContent === "" && disabledCount > 0) {
            statusEl.textContent = "Some providers are not configured and are disabled.";
        }
    }

    window.addEventListener('DOMContentLoaded', loadProviderStatus);

    // 4. Download the latest JSON rules
    function downloadJson() {
        if (!latestConfig) {
            alert("No JSON rules available to download.");
            return;
        }

        const jsonText = JSON.stringify(latestConfig, null, 2);
        const blob = new Blob([jsonText], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'rules.json';
        document.body.appendChild(link);
        link.click();
        link.remove();
        URL.revokeObjectURL(url);
    }
</script>
</body>
</html>
